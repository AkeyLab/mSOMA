import pytest

from msoma import count as bb_count
from msoma import pileup2counts as p2c

import os


def test_count_unexpected_keywords():
    with pytest.raises(TypeError):
        bb_count.count(
            bam_path="tests/data/test.bam",
            output_path="test.count",
            fasta_path="tests/data/test.fa",
            bed_path="tests/data/test.bed",
            seq_len=75,
            unexpected_keyword="unexpected_keyword",
        )


def test_p2c_count_pileup(tmp_path):
    fasta_data = (">1", "AAAGTACGTTGCGCG")
    fasta_path = tmp_path / "test.fa"
    fasta_path.write_text("\n".join(fasta_data))
    fasta_path = str(fasta_path)

    mpileup_data = (
        "#mpileup header",
        "1\t4\tG\t195\t.$.$............,,......................,...........,,,..,......,...,.,,..,..,...,..............,.......,,........,..,.,......,......,...,......,,...,..,..,.........,......,............,.,.....,,^].^],\tooJKtKKqKJJpwu?GvIwIMuuLvLqLLvqLLvKLLLKLLLtuLtILLLKKKIIMLfLLLLKLILKLLHLrKLMKKLKJLLLLLLLLLLLLLwKLLKqLLLJKLLLLLLLLKwLKLLKLMLLL9LLLLLLKKLLLLLLLLKLKKJBKLLJLLLKLKLKLILKKLILKIHKIJILJHIKKIJJIIHGGIJJDIDE	]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]	75,75,74,74,73,73,73,71,70,70,70,69,69,69,69,68,67,67,67,66,66,64,64,64,63,62,60,59,59,59,59,58,56,56,56,56,56,56,56,55,55,55,54,54,53,53,53,52,52,52,51,50,50,49,49,49,48,48,47,47,47,47,47,43,43,43,43,42,42,42,41,41,41,40,40,40,39,39,38,38,37,37,37,36,36,36,36,35,35,35,33,33,33,33,33,31,31,31,31,30,30,30,29,29,28,28,28,27,27,27,27,27,27,26,26,26,25,25,24,24,24,23,23,23,23,22,22,21,21,21,21,21,20,19,19,19,18,18,18,18,18,18,17,17,16,16,16,16,15,15,15,14,13,13,12,12,12,12,12,11,11,11,11,10,9,9,9,9,9,9,9,8,7,7,6,6,6,5,5,5,4,4,4,4,3,3,2,2,2,2,2,2,2,1,1\tQNAME1,QNAME2,QNAME3,QNAME4,QNAME5,QNAME6,QNAME7,QNAME8,QNAME9,QNAME10,QNAME11,QNAME12,QNAME13,QNAME14,QNAME15,QNAME16,QNAME17,QNAME18,QNAME19,QNAME20,QNAME21,QNAME22,QNAME23,QNAME24,QNAME25,QNAME26,QNAME27,QNAME28,QNAME29,QNAME30,QNAME31,QNAME32,QNAME33,QNAME34,QNAME35,QNAME36,QNAME37,QNAME38,QNAME39,QNAME40,QNAME41,QNAME42,QNAME43,QNAME44,QNAME45,QNAME46,QNAME47,QNAME48,QNAME49,QNAME50,QNAME51,QNAME52,QNAME53,QNAME54,QNAME55,QNAME56,QNAME57,QNAME58,QNAME59,QNAME60,QNAME61,QNAME62,QNAME63,QNAME64,QNAME65,QNAME66,QNAME67,QNAME68,QNAME69,QNAME70,QNAME71,QNAME72,QNAME73,QNAME74,QNAME75,QNAME76,QNAME77,QNAME78,QNAME79,QNAME80,QNAME81,QNAME82,QNAME83,QNAME84,QNAME85,QNAME86,QNAME87,QNAME88,QNAME89,QNAME90,QNAME91,QNAME92,QNAME93,QNAME94,QNAME95,QNAME96,QNAME97,QNAME98,QNAME99,QNAME100,QNAME101,QNAME102,QNAME103,QNAME104,QNAME105,QNAME106,QNAME107,QNAME108,QNAME109,QNAME110,QNAME111,QNAME112,QNAME113,QNAME114,QNAME115,QNAME116,QNAME117,QNAME118,QNAME119,QNAME120,QNAME121,QNAME122,QNAME123,QNAME124,QNAME125,QNAME126,QNAME127,QNAME128,QNAME129,QNAME130,QNAME131,QNAME132,QNAME133,QNAME134,QNAME135,QNAME136,QNAME137,QNAME138,QNAME139,QNAME140,QNAME141,QNAME142,QNAME143,QNAME144,QNAME145,QNAME146,QNAME147,QNAME148,QNAME149,QNAME150,QNAME151,QNAME152,QNAME153,QNAME154,QNAME155,QNAME156,QNAME157,QNAME158,QNAME159,QNAME160,QNAME161,QNAME162,QNAME163,QNAME164,QNAME165,QNAME166,QNAME167,QNAME168,QNAME169,QNAME170,QNAME171,QNAME172,QNAME173,QNAME174,QNAME175,QNAME176,QNAME177,QNAME178,QNAME179,QNAME180,QNAME181,QNAME182,QNAME183,QNAME184,QNAME185,QNAME186,QNAME187,QNAME188,QNAME189,QNAME190,QNAME191,QNAME192,QNAME193,QNAME194,QNAME195",
        "1\t5\tT\t198\t.$.$..........,.,......................,,...........,,,..,......,...,.,,..,..,...,..............,.......,,........,..,,.,......,......,...,......,,...,..,..,.........,......,............,.,.....,,.,^].^].\tDCkEEmFDDjjjEBEjDjDDiiDjDiDDiiDDjDDDDGGDDDjiDjDDDDGGFDDGD_DDDDEDDDGDGFDjFDDGDDDGDDDDDDDDDDDDDiFDDDjDDDFFCCDDhDDDFjDBFDGDDDDDD7DDDDDDFDDCEDDDDDDHGCCDEDDEDDGDDDDCCDDCDDCCCCDACCCCCCBCBCCDGBHCCBCCFHAFDD	]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]	75,75,74,74,74,72,71,71,71,70,70,70,70,69,69,68,68,68,67,67,65,65,65,64,63,61,60,60,60,60,59,57,57,57,57,57,57,57,57,56,56,56,55,55,54,54,54,53,53,53,52,51,51,50,50,50,49,49,48,48,48,48,48,44,44,44,44,43,43,43,42,42,42,41,41,41,40,40,39,39,38,38,38,37,37,37,37,36,36,36,34,34,34,34,34,32,32,32,32,31,31,31,30,30,29,29,29,28,28,28,28,28,28,27,27,27,27,26,26,25,25,25,24,24,24,24,23,23,22,22,22,22,22,21,20,20,20,19,19,19,19,19,19,18,18,17,17,17,17,16,16,16,15,14,14,13,13,13,13,13,12,12,12,12,11,10,10,10,10,10,10,10,9,8,8,7,7,7,6,6,6,5,5,5,5,4,4,3,3,3,3,3,3,3,2,2,1,1\tQNAME1,QNAME2,QNAME3,QNAME4,QNAME5,QNAME6,QNAME7,QNAME8,QNAME9,QNAME10,QNAME11,QNAME12,QNAME13,QNAME14,QNAME15,QNAME16,QNAME17,QNAME18,QNAME19,QNAME20,QNAME21,QNAME22,QNAME23,QNAME24,QNAME25,QNAME26,QNAME27,QNAME28,QNAME29,QNAME30,QNAME31,QNAME32,QNAME33,QNAME34,QNAME35,QNAME36,QNAME37,QNAME38,QNAME39,QNAME40,QNAME41,QNAME42,QNAME43,QNAME44,QNAME45,QNAME46,QNAME47,QNAME48,QNAME49,QNAME50,QNAME51,QNAME52,QNAME53,QNAME54,QNAME55,QNAME56,QNAME57,QNAME58,QNAME59,QNAME60,QNAME61,QNAME62,QNAME63,QNAME64,QNAME65,QNAME66,QNAME67,QNAME68,QNAME69,QNAME70,QNAME71,QNAME72,QNAME73,QNAME74,QNAME75,QNAME76,QNAME77,QNAME78,QNAME79,QNAME80,QNAME81,QNAME82,QNAME83,QNAME84,QNAME85,QNAME86,QNAME87,QNAME88,QNAME89,QNAME90,QNAME91,QNAME92,QNAME93,QNAME94,QNAME95,QNAME96,QNAME97,QNAME98,QNAME99,QNAME100,QNAME101,QNAME102,QNAME103,QNAME104,QNAME105,QNAME106,QNAME107,QNAME108,QNAME109,QNAME110,QNAME111,QNAME112,QNAME113,QNAME114,QNAME115,QNAME116,QNAME117,QNAME118,QNAME119,QNAME120,QNAME121,QNAME122,QNAME123,QNAME124,QNAME125,QNAME126,QNAME127,QNAME128,QNAME129,QNAME130,QNAME131,QNAME132,QNAME133,QNAME134,QNAME135,QNAME136,QNAME137,QNAME138,QNAME139,QNAME140,QNAME141,QNAME142,QNAME143,QNAME144,QNAME145,QNAME146,QNAME147,QNAME148,QNAME149,QNAME150,QNAME151,QNAME152,QNAME153,QNAME154,QNAME155,QNAME156,QNAME157,QNAME158,QNAME159,QNAME160,QNAME161,QNAME162,QNAME163,QNAME164,QNAME165,QNAME166,QNAME167,QNAME168,QNAME169,QNAME170,QNAME171,QNAME172,QNAME173,QNAME174,QNAME175,QNAME176,QNAME177,QNAME178,QNAME179,QNAME180,QNAME181,QNAME182,QNAME183,QNAME184,QNAME185,QNAME186,QNAME187,QNAME188,QNAME189,QNAME190,QNAME191,QNAME192,QNAME193,QNAME194,QNAME195,QNAME196,QNAME197,QNAME198",
        "1\t6\tA\t197\t.$.$.$.......,.,......................,,...........,,,..,......,...,.,,..,..,...,..............,.......,,........,..,,.,......,......,...,......,,...,..,..,.........,......,............,.,.....,,.,..^].\tnEEmIIItsvJ=IvHvKKvpLvJtLKvvKHxMJJKKKKKLvvKtIKKKLLLLKLLgLKKKLKKKLLL@LvLLLKKKKLJKLLLLLLKKLLKvLKKKtKKKLLKJKKvLKKKwLLLKMKLLLLK<KKJLKLLKKLJKLJKKKKLKHHLHKLKKLJKJKKLJKKMLJKKJHIKIJLJHJKJJLFJG?FFHIEJKEJ?HA	]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]	75,75,75,73,72,72,72,71,71,71,71,70,70,69,69,69,68,68,66,66,66,65,64,62,61,61,61,61,60,58,58,58,58,58,58,58,58,57,57,57,56,56,55,55,55,54,54,54,53,52,52,51,51,51,50,50,49,49,49,49,49,45,45,45,45,44,44,44,43,43,43,42,42,42,41,41,40,40,39,39,39,38,38,38,38,37,37,37,35,35,35,35,35,33,33,33,33,32,32,32,31,31,30,30,30,29,29,29,29,29,29,28,28,28,28,27,27,26,26,26,25,25,25,25,24,24,23,23,23,23,23,22,21,21,21,20,20,20,20,20,20,19,19,18,18,18,18,17,17,17,16,15,15,14,14,14,14,14,13,13,13,13,12,11,11,11,11,11,11,11,10,9,9,8,8,8,7,7,7,6,6,6,6,5,5,4,4,4,4,4,4,4,3,3,2,2,1\tQNAME1,QNAME2,QNAME3,QNAME4,QNAME5,QNAME6,QNAME7,QNAME8,QNAME9,QNAME10,QNAME11,QNAME12,QNAME13,QNAME14,QNAME15,QNAME16,QNAME17,QNAME18,QNAME19,QNAME20,QNAME21,QNAME22,QNAME23,QNAME24,QNAME25,QNAME26,QNAME27,QNAME28,QNAME29,QNAME30,QNAME31,QNAME32,QNAME33,QNAME34,QNAME35,QNAME36,QNAME37,QNAME38,QNAME39,QNAME40,QNAME41,QNAME42,QNAME43,QNAME44,QNAME45,QNAME46,QNAME47,QNAME48,QNAME49,QNAME50,QNAME51,QNAME52,QNAME53,QNAME54,QNAME55,QNAME56,QNAME57,QNAME58,QNAME59,QNAME60,QNAME61,QNAME62,QNAME63,QNAME64,QNAME65,QNAME66,QNAME67,QNAME68,QNAME69,QNAME70,QNAME71,QNAME72,QNAME73,QNAME74,QNAME75,QNAME76,QNAME77,QNAME78,QNAME79,QNAME80,QNAME81,QNAME82,QNAME83,QNAME84,QNAME85,QNAME86,QNAME87,QNAME88,QNAME89,QNAME90,QNAME91,QNAME92,QNAME93,QNAME94,QNAME95,QNAME96,QNAME97,QNAME98,QNAME99,QNAME100,QNAME101,QNAME102,QNAME103,QNAME104,QNAME105,QNAME106,QNAME107,QNAME108,QNAME109,QNAME110,QNAME111,QNAME112,QNAME113,QNAME114,QNAME115,QNAME116,QNAME117,QNAME118,QNAME119,QNAME120,QNAME121,QNAME122,QNAME123,QNAME124,QNAME125,QNAME126,QNAME127,QNAME128,QNAME129,QNAME130,QNAME131,QNAME132,QNAME133,QNAME134,QNAME135,QNAME136,QNAME137,QNAME138,QNAME139,QNAME140,QNAME141,QNAME142,QNAME143,QNAME144,QNAME145,QNAME146,QNAME147,QNAME148,QNAME149,QNAME150,QNAME151,QNAME152,QNAME153,QNAME154,QNAME155,QNAME156,QNAME157,QNAME158,QNAME159,QNAME160,QNAME161,QNAME162,QNAME163,QNAME164,QNAME165,QNAME166,QNAME167,QNAME168,QNAME169,QNAME170,QNAME171,QNAME172,QNAME173,QNAME174,QNAME175,QNAME176,QNAME177,QNAME178,QNAME179,QNAME180,QNAME181,QNAME182,QNAME183,QNAME184,QNAME185,QNAME186,QNAME187,QNAME188,QNAME189,QNAME190,QNAME191,QNAME192,QNAME193,QNAME194,QNAME195,QNAME196,QNAME197",
        "1\t7\tC\t198\t.....A.,.,.....A................,,...........,,,..,......,...,.,,..,..,...,..............,.......,,,........,..,,.,......,......,...,......,,...,..,..,.........,......,............,.,.....,,.,...^].^].^].\tnJJIsqpGHFpJoJKppJoJoJIqqKJqJJJKGGJJJpqJpJJJJFGGJJGIkJJJJHJIJGnGBIqGJJGJAJGJJJJJJJJJKJJJqGJIJpJJJGEGJJJJtKJJGpJGGJGJJJJJJ7JJJJIJGJJJGHHJJJJFFJHHGIJGJJGJJJJJJIJIGJIJIIIGIIIJIGIJJIIIGHGIIJJIHIJEJIIDAA	]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]]	74,73,73,73,72,72,72,72,71,71,70,70,70,69,69,67,67,67,66,65,63,62,62,62,62,61,59,59,59,59,59,59,59,59,58,58,58,57,57,56,56,56,55,55,55,54,53,53,52,52,52,51,51,50,50,50,50,50,46,46,46,46,45,45,45,44,44,44,43,43,43,42,42,41,41,40,40,40,39,39,39,39,38,38,38,36,36,36,36,36,34,34,34,34,33,33,33,33,32,32,31,31,31,30,30,30,30,30,30,29,29,29,29,28,28,27,27,27,26,26,26,26,25,25,24,24,24,24,24,23,22,22,22,21,21,21,21,21,21,20,20,19,19,19,19,18,18,18,17,16,16,15,15,15,15,15,14,14,14,14,13,12,12,12,12,12,12,12,11,10,10,9,9,9,8,8,8,7,7,7,7,6,6,5,5,5,5,5,5,5,4,4,3,3,2,1,1,1\tQNAME1,QNAME2,QNAME3,QNAME4,QNAME5,QNAME6,QNAME7,QNAME8,QNAME9,QNAME10,QNAME11,QNAME12,QNAME13,QNAME14,QNAME15,QNAME16,QNAME17,QNAME18,QNAME19,QNAME20,QNAME21,QNAME22,QNAME23,QNAME24,QNAME25,QNAME26,QNAME27,QNAME28,QNAME29,QNAME30,QNAME31,QNAME32,QNAME33,QNAME34,QNAME35,QNAME36,QNAME37,QNAME38,QNAME39,QNAME40,QNAME41,QNAME42,QNAME43,QNAME44,QNAME45,QNAME46,QNAME47,QNAME48,QNAME49,QNAME50,QNAME51,QNAME52,QNAME53,QNAME54,QNAME55,QNAME56,QNAME57,QNAME58,QNAME59,QNAME60,QNAME61,QNAME62,QNAME63,QNAME64,QNAME65,QNAME66,QNAME67,QNAME68,QNAME69,QNAME70,QNAME71,QNAME72,QNAME73,QNAME74,QNAME75,QNAME76,QNAME77,QNAME78,QNAME79,QNAME80,QNAME81,QNAME82,QNAME83,QNAME84,QNAME85,QNAME86,QNAME87,QNAME88,QNAME89,QNAME90,QNAME91,QNAME92,QNAME93,QNAME94,QNAME95,QNAME96,QNAME97,QNAME98,QNAME99,QNAME100,QNAME101,QNAME102,QNAME103,QNAME104,QNAME105,QNAME106,QNAME107,QNAME108,QNAME109,QNAME110,QNAME111,QNAME112,QNAME113,QNAME114,QNAME115,QNAME116,QNAME117,QNAME118,QNAME119,QNAME120,QNAME121,QNAME122,QNAME123,QNAME124,QNAME125,QNAME126,QNAME127,QNAME128,QNAME129,QNAME130,QNAME131,QNAME132,QNAME133,QNAME134,QNAME135,QNAME136,QNAME137,QNAME138,QNAME139,QNAME140,QNAME141,QNAME142,QNAME143,QNAME144,QNAME145,QNAME146,QNAME147,QNAME148,QNAME149,QNAME150,QNAME151,QNAME152,QNAME153,QNAME154,QNAME155,QNAME156,QNAME157,QNAME158,QNAME159,QNAME160,QNAME161,QNAME162,QNAME163,QNAME164,QNAME165,QNAME166,QNAME167,QNAME168,QNAME169,QNAME170,QNAME171,QNAME172,QNAME173,QNAME174,QNAME175,QNAME176,QNAME177,QNAME178,QNAME179,QNAME180,QNAME181,QNAME182,QNAME183,QNAME184,QNAME185,QNAME186,QNAME187,QNAME188,QNAME189,QNAME190,QNAME191,QNAME192,QNAME193,QNAME194,QNAME195,QNAME196,QNAME197,QNAME198",
    )
    mpileup_path = tmp_path / "test.mpileup"
    mpileup_path.write_text("\n".join(mpileup_data))
    mpileup_path = str(mpileup_path)

    output_path = tmp_path / "test.count"
    output_path = str(output_path)

    p2c.count_pileup(
        fasta=fasta_path, seqlen=75, output=output_path, mpileup=mpileup_path
    )

    assert os.path.exists(output_path + ".gz")
    assert os.path.exists(output_path + ".gz.tbi")
    assert os.path.exists(output_path + ".alt.txt")
